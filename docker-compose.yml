version: '3.9'
services:
  api:
    build:
      context: .
      dockerfile: docker/Dockerfile
    env_file:
      - .env
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - QDRANT_URL=${QDRANT_URL}
      - QDRANT_API_KEY=${QDRANT_API_KEY}
      - EMBEDDING_DIM=${EMBEDDING_DIM}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRE_MINUTES=${JWT_EXPIRE_MINUTES}
      - ALLOW_ANONYMOUS_READ=${ALLOW_ANONYMOUS_READ}
      - UPLOAD_DIR=${UPLOAD_DIR}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL}
    ports:
      - "9981:8000"
    volumes:
      - ./volume/uploads:${UPLOAD_DIR}
    depends_on:
      mysql:
        condition: service_healthy
      qdrant:
        condition: service_started
  mysql:
    image: mysql:8.0
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: kb
      MYSQL_USER: kb
      MYSQL_PASSWORD: kbpass
    ports:
      - "33066:3306"
    volumes:
      - ./volume/mysql:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -prootpass"]
      interval: 5s
      timeout: 5s
      retries: 10
  qdrant:
    image: qdrant/qdrant:latest
    restart: unless-stopped
    ports:
      - "6333:6333"
    volumes:
      - ./volume/qdrant:/qdrant/storage
  adminer:
    image: adminer
    restart: unless-stopped
    ports:
      - "8080:8080"
